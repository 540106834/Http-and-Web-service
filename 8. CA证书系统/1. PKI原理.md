# PKI原理

## PKI（Public Key Infrastructure）公共密钥基础设施

 它是一套体系，用来实现三件事：

1. **你是谁（身份）**
2. **这句话确实你说的（签名）**
3. **传输途中没人偷听（加密）**

它依靠“非对称加密 + 证书 + CA 体系”构建一个全球信任网络，让浏览器与服务器能像老友对暗号一样认彼此。

## PKI 用于哪些场景？

你每天都在使用它：

- 浏览器访问 HTTPS
- VPN（例如 OpenVPN）
- 电子签名、合同平台
- Kubernetes TLS
- Docker Registry TLS
- 邮件 S/MIME
- 零信任架构中的身份认证

本质：**任何需要加密 + 身份认证的地方，都需要 PKI**。



# 1. 根之源：CA 私钥

**CA（Certificate Authority）证书颁发机构**

流水线的开端是一把沉甸甸的私钥，它从不亮相，只在安全的房间里沉睡。

它能做两件事：

1. **签名**
2. **颁发证书**

谁得到它的签名，谁就获得了“信任凭据”。

CA 私钥从不离开服务器，就像王国的印章永不外借。

---

# 2. 自我加冕：根证书 (Root CA Certificate)

CA 拿着自己的私钥，给自己的公钥盖一枚签名，生成根证书。

也就是：

```
RootCA.key → RootCA.crt  
```

这叫 **自签名证书**。

浏览器/系统必须手工信任 RootCA.crt，否则所有下级证书都不被认可。

它是信任树的“树根”。

---

# 3. 服务端私钥：独属于服务器

服务端生成自己的私钥（server.key）。
它像服务器的“内功心法”，用于解密、握手、签名验证。

这把私钥永远不能给别人。

---

# 4. 证书签发请求：CSR

服务端用自己的私钥生成一个 CSR（server.csr）。

CSR 包含：

* 服务器公钥
* 服务器身份（CN、SAN 等）
* 服务器用私钥签了一下，证明“这是我的”

CSR 就是“我要领证”的申请表。

---

# 5. CA 审核并签发：server.crt

CA 看到 CSR 说：

> 好，我确认你提供了合法的公钥，并且证明它属于你，我可以签字。

然后做一件事：

```
CSR 的内容 + CA 的私钥 → server.crt
```

server.crt 实质是：

* 含 server 公钥
* 含身份信息（域名、用途）
* 含 CA 的签名

浏览器验证证书，就是看这个“签名链”。

---

# 6. 信任链：fullchain.crt

为了让浏览器一路顺藤摸瓜，必须让它看到：

```
leaf server cert
↓
intermediate CA cert（可选）
↓
root CA cert
```

所以服务端把这几个证书 **按顺序拼接** 成 fullchain.crt。
这是“流水线的最终产物”，交付给 Nginx / OpenSSL / 客户端使用。

---

# 7. 浏览器验证整个体系

当浏览器收到 fullchain.crt，它会做三件事：

### ① 看证书是否属于目标域名

通过 SAN 判断
如果你访问 example.com
证书必须包含 example.com 或 *.example.com

### ② 验证 server.crt 的签名

用 CA.cert 的公钥验证它的签名是否真实。

这就是 CA 为什么重要。

### ③ 根证书是否在“信任仓库”里

浏览器系统都会有一个“系统信任库”，里面放着根证书。

如果 RootCA.crt 不在其中：

```
NET::ERR_CERT_AUTHORITY_INVALID
```

你会看到熟悉的“红色警告页”。

---

# 8. TLS 握手如何用证书

TLS 连接时，证书的作用是：

1. 服务端出示 server.crt
2. 浏览器验证链是否可信
3. 浏览器生成一个随机对称密钥(单次)
4. 用 **server 公钥加密** 随机密钥
5. 服务端用 **server.key 解密**
6. 后续全部使用对称加密

> **证书本身并不用于加解密内容，只是为了身份信任。**
> **真正的 HTTPS 流量保护依赖后续协商出的对称密钥。**

---

# 9. 整条流水线总结（最精华图）

```
[Root CA 私钥] → [Root CA 证书]
             ↓
         签发服务器CSR
             ↓
[server.key] → CSR → [CA 签名] → server.crt
             ↓
     fullchain.crt = server.crt + ca.crt
```

浏览器不会长期保存服务器证书。
 它们只在一个连接存活期间短暂驻留，连接结束就消散了。
