# è‡ªå»º CA å’ŒæœåŠ¡ç«¯è¯ä¹¦è„šæœ¬

**è„šæœ¬ä½¿ç”¨ OpenSSLï¼Œç›®å½•ç»“æ„æ¸…æ™°ï¼Œè¾“å‡ºå†…å®¹å¯ç›´æ¥ç»™ Nginx ä½¿ç”¨ã€‚æ‰€æœ‰å‘½ä»¤å¯ä»¥æ”¾è¿› `gen-cert.sh` ç›´æ¥è¿è¡Œã€‚**



#  ä¸€é”®è„šæœ¬ï¼šç”Ÿæˆè‡ªå»º CA + æœåŠ¡ç«¯è¯ä¹¦

```bash
#!/bin/bash

set -e

BASE_DIR=certs
CA_DIR=$BASE_DIR/ca
SERVER_DIR=$BASE_DIR/server

mkdir -p $CA_DIR $SERVER_DIR

echo "==> 1. ç”Ÿæˆ CA ç§é’¥"
openssl genrsa -out $CA_DIR/ca.key 4096

echo "==> 2. ç”Ÿæˆ CA æ ¹è¯ä¹¦ï¼ˆæœ‰æ•ˆæœŸ 10 å¹´ï¼‰"
openssl req -x509 -new -nodes \
  -key $CA_DIR/ca.key \
  -sha256 \
  -days 3650 \
  -subj "/C=CN/ST=DevOps/L=Local/O=MyCA/OU=RootCA/CN=My-Root-CA" \
  -out $CA_DIR/ca.crt

echo "==> 3. ç”ŸæˆæœåŠ¡å™¨ç§é’¥"
openssl genrsa -out $SERVER_DIR/server.key 2048

echo "==> 4. ç”ŸæˆæœåŠ¡å™¨ CSR"
openssl req -new \
  -key $SERVER_DIR/server.key \
  -subj "/C=CN/ST=DevOps/L=Local/O=MyServer/OU=IT/CN=localhost" \
  -out $SERVER_DIR/server.csr

echo "==> 5. ç”ŸæˆæœåŠ¡å™¨æ‰©å±•é…ç½® ext æ–‡ä»¶"
cat > $SERVER_DIR/server.ext <<EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = 127.0.0.1
IP.1 = 127.0.0.1
EOF

echo "==> 6. ç”¨ CA ç­¾å‘æœåŠ¡ç«¯è¯ä¹¦"
openssl x509 -req \
  -in $SERVER_DIR/server.csr \
  -CA $CA_DIR/ca.crt \
  -CAkey $CA_DIR/ca.key \
  -CAcreateserial \
  -out $SERVER_DIR/server.crt \
  -days 825 \
  -sha256 \
  -extfile $SERVER_DIR/server.ext

echo "==> 7. æ‹¼æ¥ server.crt + CA é“¾ï¼ˆå¯é€‰ï¼‰"
cat $SERVER_DIR/server.crt $CA_DIR/ca.crt > $SERVER_DIR/server.fullchain.crt

echo ""
echo "==> å…¨éƒ¨å®Œæˆï¼è¾“å‡ºç»“æ„å¦‚ä¸‹ï¼š"
tree $BASE_DIR

echo ""
echo "==> Nginx é…ç½®å‚è€ƒï¼š"
echo "ssl_certificate      /etc/nginx/certs/server.fullchain.crt"
echo "ssl_certificate_key  /etc/nginx/certs/server.key"
```

# è¾“å‡ºç›®å½•ç»“æ„ï¼ˆæ‰§è¡Œå®Œè‡ªåŠ¨å‡ºç°ï¼‰

```
certs/
 â”œâ”€â”€ ca/
 â”‚    â”œâ”€â”€ ca.key               # CA ç§é’¥
 â”‚    â”œâ”€â”€ ca.crt               # æ ¹è¯ä¹¦
 â”‚    â””â”€â”€ ca.srl               # åºåˆ—å·
 â””â”€â”€ server/
      â”œâ”€â”€ server.key           # æœåŠ¡ç«¯ç§é’¥
      â”œâ”€â”€ server.csr           # è¯ä¹¦ç­¾å‘è¯·æ±‚
      â”œâ”€â”€ server.crt           # æœåŠ¡ç«¯è¯ä¹¦
      â”œâ”€â”€ server.ext           # æ‰©å±•å­—æ®µ (SAN ç­‰)
      â””â”€â”€ server.fullchain.crt # æœåŠ¡ç«¯è¯ä¹¦ + CA é“¾
```

---

# Nginx é…ç½®ï¼ˆç›´æ¥å¯ç”¨ï¼‰

```nginx
ssl_certificate      /etc/nginx/certs/server.crt;
ssl_certificate_key  /etc/nginx/certs/server.key;
```



# å¯é€‰ï¼šæ·»åŠ  SANï¼ˆåŸŸå/IPï¼‰

ç›´æ¥ä¿®æ”¹ `server.ext` é‡Œé¢çš„ï¼š

```
DNS.1 = example.com
DNS.2 = *.example.com
IP.1 = 10.0.0.10
```

---

# è„šæœ¬è§£é‡Šï¼š

---

## 1. å…¨å±€ç»“æ„ï¼šç›®å½•å‡†å¤‡

```bash
BASE_DIR=certs
CA_DIR=$BASE_DIR/ca
SERVER_DIR=$BASE_DIR/server

mkdir -p $CA_DIR $SERVER_DIR
```

è„šæœ¬é¦–å…ˆæ­å»ºä¸€ä¸ªå°å‹ PKI å·¥åŠï¼š

```
certs/
 â”œâ”€â”€ ca/        è´Ÿè´£åˆ¶é€ å’Œä¿ç®¡â€œæ ¹è¯ä¹¦â€
 â””â”€â”€ server/    è´Ÿè´£ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
```

è¿™æ˜¯ä¸ºäº†é¿å…æ–‡ä»¶å †åœ¨ä¸€èµ·ï¼Œåç»­æŸ¥æ‰¾å’Œéƒ¨ç½²éƒ½æ›´æ¸…é†’ã€‚

---

## 2. ç”Ÿæˆ CA ç§é’¥

```bash
openssl genrsa -out $CA_DIR/ca.key 4096
```

è¿™æ˜¯æ•´ä¸ªâ€œè¯ä¹¦ç‹å›½â€çš„å›½ç‹ç§é’¥ï¼Œæ‰€æœ‰ç­¾å‘éƒ½é å®ƒï¼Œå› æ­¤è¦ç”¨ 4096 bit ç¨æ˜¾éš†é‡ã€‚
æ–‡ä»¶ï¼š`ca.key`
ç”¨é€”ï¼šç­¾å‘æ‰€æœ‰ä¸‹çº§è¯ä¹¦ï¼ŒåŒ…æ‹¬ server.crtã€‚

---

## 3. ç”Ÿæˆ CA æ ¹è¯ä¹¦ï¼ˆè‡ªç­¾åï¼‰

```bash
openssl req -x509 -new -nodes \
  -key $CA_DIR/ca.key \
  -sha256 \
  -days 3650 \
  -subj "/C=CN/.../CN=My-Root-CA" \
  -out $CA_DIR/ca.crt
```

è¿™æ˜¯â€œå›½ç‹â€ç»™è‡ªå·±æˆ´çš‡å† ã€‚

ç‰¹ç‚¹ï¼š

* `-x509` è¡¨ç¤ºè‡ªç­¾å
* `ca.key` æ˜¯å®ƒè‡ªå·±çš„ç§é’¥
* æœ‰æ•ˆæœŸ 10 å¹´
* è¾“å‡ºï¼š`ca.crt`

æµè§ˆå™¨/ç³»ç»Ÿä¿¡ä»»æ­¤ CA æ‰èƒ½ä¿¡ä»»å®ƒç­¾å‘çš„æ‰€æœ‰æœåŠ¡å™¨è¯ä¹¦ã€‚

---

## 4. ç”ŸæˆæœåŠ¡å™¨ç§é’¥

```bash
openssl genrsa -out $SERVER_DIR/server.key 2048
```

è¿™æ˜¯â€œæœåŠ¡å™¨çš„ç§äººé’¥åŒ™â€ï¼Œç¨çŸ­ä¸€äº›ä¹Ÿè¶³å¤Ÿå®‰å…¨ã€‚

åç»­ Nginx ä½¿ç”¨å®ƒè¿›è¡Œè§£å¯†ã€æ¡æ‰‹ã€‚

---

## 5. ç”ŸæˆæœåŠ¡å™¨ CSRï¼ˆè¯ä¹¦ç­¾å‘è¯·æ±‚ï¼‰

```bash
openssl req -new \
  -key $SERVER_DIR/server.key \
  -subj "/C=CN/.../CN=localhost" \
  -out $SERVER_DIR/server.csr
```

CSR å°±åƒâ€œå‘ CA é€’äº¤ç”³è¯·è¡¨â€ï¼š

* åŒ…å«æœåŠ¡å™¨å…¬é’¥
* åŒ…å«ä¸»ä½“ä¿¡æ¯ï¼ˆCN=localhostï¼‰
* ç”¨ server.key ç­¾åï¼Œè¯æ˜æ‰€æœ‰æƒ

CA ä¼šæ ¹æ® CSR å†³å®šå¦‚ä½•ç­¾å‘ server.crtã€‚

---

## 6. å†™ä¸€ä¸ª ext é…ç½®æ–‡ä»¶ï¼ˆæ·»åŠ  SANï¼‰

```bash
cat > $SERVER_DIR/server.ext <<EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = 127.0.0.1
IP.1 = 127.0.0.1
EOF
```

æµè§ˆå™¨å¼ºåˆ¶è¦æ±‚è¯ä¹¦å¿…é¡»åŒ…å« **SAN (Subject Alternative Name)**ï¼Œä¸ç„¶ä¼šæŠ¥ï¼š

```
NET::ERR_CERT_COMMON_NAME_INVALID
```

æ‰€ä»¥è¿™é‡Œé€šè¿‡ ext æ–‡ä»¶å£°æ˜è¯ä¹¦ç”¨é€”ã€çº¦æŸå’Œå¯ç”¨åŸŸåã€‚

---

## 7. CA ä¸ºæœåŠ¡å™¨ç­¾å‘è¯ä¹¦

```bash
openssl x509 -req \
  -in $SERVER_DIR/server.csr \
  -CA $CA_DIR/ca.crt \
  -CAkey $CA_DIR/ca.key \
  -CAcreateserial \
  -out $SERVER_DIR/server.crt \
  -days 825 \
  -sha256 \
  -extfile $SERVER_DIR/server.ext
```

åƒ CA æ‹¿ç€ CSRï¼ŒæŸ¥çœ‹ ext æ–‡ä»¶å†…å®¹ï¼Œç„¶åç›–ä¸Šé‡‘è‰²å°ç« ï¼š

* `CA=ca.crt+ca.key` ä»£è¡¨ç”±è‡ªå»º CA ç­¾å‘
* `CAcreateserial` åˆ›å»ºåºåˆ—å·æ–‡ä»¶ `ca.srl`
* æœ‰æ•ˆæœŸ 825 å¤©ï¼ˆä¸šç•Œé€šç”¨ä¸Šé™ï¼‰
* æ·»åŠ  SAN æ‰©å±•

æœ€ç»ˆè¾“å‡ºï¼š`server.crt`

---

## 8. æ‹¼æ¥ fullchainï¼ˆæœåŠ¡ç«¯è¯ä¹¦ + CAï¼‰

```bash
cat $SERVER_DIR/server.crt $CA_DIR/ca.crt > $SERVER_DIR/server.fullchain.crt
```

Nginx æˆ–æŸäº›å®¢æˆ·ç«¯éœ€è¦å®Œæ•´é“¾ï¼Œå¦åˆ™ä¼šå¼¹ï¼š

```
chain incomplete
unable to get local issuer certificate
```

æ”¾ä¸€èµ·åï¼š

```
leaf server cert
+
CA root cert
```

Nginx ä¸€æ¬¡æ€§é€ç»™æµè§ˆå™¨ã€‚

---

## 9. æ–‡ä»¶ç»“æ„å±•ç¤º

```bash
tree $BASE_DIR
```

çº¯ç²¹å°±æ˜¯ä¸ºäº†è®©ä½ è§†è§‰ä¸Šç¡®è®¤æ‰€æœ‰æ–‡ä»¶éƒ½é½Šåœ¨ã€‚

---

## 10. è¾“å‡º Nginx å‚è€ƒé…ç½®

```bash
ssl_certificate      /etc/nginx/certs/server.fullchain.crt
ssl_certificate_key  /etc/nginx/certs/server.key
```

è¿™æ˜¯æœ€å¸¸ç”¨çš„å¯ç›´æ¥å¤åˆ¶ã€‚

---

## æ€»ç»“æˆä¸€æ¡â€œè¯ä¹¦æµæ°´çº¿â€

```
CA key  â†’ CA cert â†’ server key â†’ server CSR â†’ ext â†’ server cert â†’ fullchain
```

æ¯ä¸€æ­¥éƒ½é¡ºæ»‘è¡”æ¥ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜èƒ½ç»§ç»­å¸®ä½ ï¼š

ğŸŸ© åŠ ä¸­çº§ CAï¼Œè®©ä½ çš„ PKI æ›´çœŸå®
ğŸŸ¦ ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”¨äºåŒå‘ TLS
ğŸŸ§ è‡ªåŠ¨ç»­æœŸè„šæœ¬
ğŸŸª ç”¨ Docker ä¸€é”®è¿è¡Œæ•´ä¸ª HTTPS + Nginx ç¯å¢ƒ

ä½ æƒ³æ‰©å±•å“ªä¸€å—ï¼Ÿ
