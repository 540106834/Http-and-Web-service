# TLS 是如何建立的（以 TLS 1.3 为准）



## **步骤 0：TCP 握手完成**

TLS 必须站在 TCP 的肩膀上。舞台搭好之后，戏才开始。

------

# **步骤 1：ClientHello（客户端开场）**

浏览器先送来一份「提议卷轴」。

内容包括：

- 支持的加密算法列表（cipher suites）
- 支持的密钥交换方式（ECDHE）
- 一串新生成的随机数（client_random）
- SNI（你要访问的域名）
- ALPN（HTTP/1.1 还是 HTTP/2）
- 支持的 TLS 版本

服务器读完后：
“好，这些我接受，那些我不接受。”

------

# **步骤 2：ServerHello（服务器回应）**

服务器给出它的选择：

- 选中的算法套件（cipher suite）
- 服务器随机数（server_random）
- 自己的证书（包含公钥）
- ECDHE 参数（用于共同生成会话密钥）

浏览器开始验证证书链是否可信。

------

# **步骤 3：密钥交换（ECDHE）**

这是 TLS 里最魔法的部分。

双方都各自生成一个椭圆曲线私钥，然后：

1. 互相交换公钥
2. 各自计算出相同的共享密钥（pre-master key）
3. 再加上双方的 random 一起搅拌，生成 session key（对称加密密钥）

外人即使看到所有公网流动的内容，也推不出密钥，因为私钥永远不会离开客户端和服务器。

------

# **步骤 4：验证并完成握手**

双方交换 `Finished` 消息，表明：

- 所有握手消息完整、未被篡改
- 都已经计算出正确的会话密钥
- 可以开始加密传输了

从这一刻起，连接正式进入「全程加密模式」。

------

# **步骤 5：加密的 HTTP 开始真正传输**

浏览器终于可以发：

```
GET / HTTP/1.1
Host: example.com
```

但传输的并不是这个文本，而是一段密文。

服务器解密后才能看到真正的 HTTP 请求。

------

#  终极总结（超简版）

TLS 建立就是这三件事：

1. **协商**要用什么算法
2. **证明**服务器身份（证书链验证）
3. **创造**双方共享的加密密钥（ECDHE）

然后 HTTP 才能在加密隧道里流动。

