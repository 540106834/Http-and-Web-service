# CDN 介绍 + 常用功能使用大全
---
# 一、CDN 是什么？

> ✅ **CDN = 分布式反向代理 + 全球缓存 + 智能调度 + 安全防护**


> **CDN 就是部署在全球各地的“超级反向代理集群”**，让用户**就近访问**网站内容，同时**隐藏源站、加速、抗攻击**。
> **PoP 就是 CDN/云厂商部署在全球各地的“前置机房节点”，负责就近接入用户流量、缓存内容和转发请求。**
> **回源负载均衡 = CDN 在缓存未命中或需要回源时，把请求合理地分发到「多个源站节点」的调度系统。**
> **单 ALB 场景下，回流负载均衡不是必需的；POP 可以直接回源。但如果希望增加监控、限流、灰度或未来扩展，多数工程仍会提前加一个回流 LB。**
> 
---
## 二、真实访问链路

```text
用户浏览器
    |
    v
DNS：域名 → 就近 CDN 节点 IP
    |
    v
CDN 边缘节点（反向代理）
    |     \
    |      \== 缓存命中 → 直接返回数据
    |
    └──── 未命中 → 回源 → 源站服务器
```

---

## 三、CDN 核心能力拆解

### ✅ 1. 反向代理

CDN 本质就是**反代入口**：

* 所有流量先到 CDN
* 源站 IP 不暴露
* 可以集中做：

  * 灰度
  * 限流
  * 鉴权
  * 安全

---

---

### ✅ 2. 缓存加速（CDN 的灵魂）

**缓存对象：**

| 类型            | 是否可缓存 |
| ------------- | ----- |
| 图片 / CSS / JS | ✅ 最常见 |
| 视频文件          | ✅     |
| ZIP 静态资源      | ✅     |
| HTML 页面       | ✅     |
| API 数据        | ✅ 可配置 |

---

**基本机制**

```text
首次请求 → 回源拉取 → 缓存到边缘节点
后续请求 → 本地直接返回
```

---

### 常用配置项

| 功能     | 用途            |
| ------ | ------------- |
| TTL    | 缓存存多长时间       |
| 路径缓存规则 | /static/* 缓存  |
| 查询参数策略 | ?v=123 是否影响缓存 |
| 缓存刷新   | 人工清 cache     |
| 缓存预热   | 主动推到 CDN      |

---

---

### ✅ 3. 智能调度（DNS + Anycast）

**目标：**

> 让用户访问**最近、最快、最健康**的节点。

---

调度维度：

* 地理位置
* 运营商
* 延迟
* 节点负载
* 健康状态

---

---

### ✅ 4. 回源负载均衡

多个源站时：

```text
CDN 节点 → SLB → 多台源站
```

支持策略：

* 轮询
* 权重
* 故障切换

---

---

### ✅ 5. 安全防护

---

#### ✅ WAF（应用防火墙）

防：

* SQL 注入
* XSS
* CSRF
* API 攻击
* WebShell 上传

---

#### ✅ DDoS 防护

防：

* CC 攻击
* SYN Flood
* UDP Flood

---

#### ✅ BOT 管理

防：

* 爬虫
* 接口刷量
* 抢券脚本
* 撞库

---

---

### ✅ 6. HTTPS 卸载

**证书托管在 CDN：**

* 浏览器 ↔ CDN：HTTPS
* CDN ↔ 源站：HTTP / HTTPS 均可

好处：

* 源站不用处理 SSL
* 大幅省 CPU

---

---

### ✅ 7. 边缘计算

在 CDN 节点运行代码：

* 鉴权
* 改 Header
* 灰度
* 接口改写

---

典型场景：

* Cloudflare Workers
* 阿里 EdgeRoutine

---

---

## 四、常用 CDN 功能实战

---

## 1️⃣ 静态资源加速（最常用）

**使用步骤：**

1. 域名接入 CDN
2. 配置缓存规则：

```text
*.js *.css *.png TTL 7天
```

3. 回源域名：绑定真实源站

---

🎯 典型收益：

* 延迟下降 50%+
* 源站带宽 ↓80%+
* 请求 QPS ↓90%+

---

---

## 2️⃣ HTML 页面缓存

CDN 可以缓存 HTML 页面

**配置注意：**

* 特定 Header 允许 cache
* Cookies 排除
* 用户登录态区分

---

**示例：**

```yaml
缓存路径: /article/*
TTL: 10分钟
忽略QueryString
```

---

---

## 3️⃣ API 加速 & 缓存

**能缓存 GET API 响应**

---

适合：

* 商品列表
* 配置接口
* 公共数据

---

需要注意：

* Vary Header
* Token 做 cache key
* 选择性缓存

---

---

## 4️⃣ 防刷 & 限流

WAF + Rate Limit：

```text
单IP 1秒请求 >100
→ 返回 429
```

用途：

* 抗爬虫
* 防短信刷接口

---

---

## 5️⃣ 灰度发布

通过 CDN 规则实现：

---

示例：

```text
UA 包含 test → 回源v2集群
其他流量 → v1集群
```

---

---

## 6️⃣ 缓存刷新/预热

---

### ✅ 刷新

```text
修改 JS
→ 刷新 CDN /static/app.js
```

---

### ✅ 预热

```text
发布活动
→ 提前请求首页
→ 内容进 CDN
```

避免首用户慢。

---

---

## 7️⃣ HTTPS 卸载

**极高性价比：**

* CDN 自动签免费证书
* 源站走 HTTP

---

---

## 8️⃣ 防 DDoS

直接开：

```text
清洗模式：自动
触发阈值：默认
```

遭攻击时：

* 流量 99% 在 CDN 清洗
* 源站压力几乎不变

---

---

## 五、CDN 实际配置顺序

✅ 上线流程标准顺序：

```text
① 购买 CDN
② 添加加速域名
③ 上传证书
④ 设置回源地址
⑤ 配缓存规则
⑥ 做限流/WAF安全配置
⑦ 预热缓存
```

---

---

## 六、生产环境最佳实践

### ✅ 一定要做

* **缓存静态**
* **HTML 可缓存**
* **API 选择性缓存**
* **开启 HTTPS**
* **开启 WAF + RateLimit**
* **定期预热首页**

---

---

### ❌ 容易踩坑

| 坑                  | 后果     |
| ------------------ | ------ |
| API 全量缓存           | 用户数据串  |
| Cookie 纳入 cacheKey | 命中率极低  |
| TTL 过短             | 缓存几乎无效 |
| 忽略回源压缩             | 源站流量激增 |
| 刷缓存不当              | 大规模回源  |

---

---

## 七、CDN 与常见组件边界

| 组件          | 解决问题      |
| ----------- | --------- |
| CDN         | 加速访问 + 缓存 |
| WAF         | Web 攻击防护  |
| SLB         | 流量分发      |
| API Gateway | 鉴权、聚合     |
| 防火墙         | 端口/IP 过滤  |

---

---

## 八、工程师记忆版一句话

### ✅ CDN 是个啥？

> **全球反向代理 + 高性能缓存 + 安全防护 + DNS 智能调度**

---

### ✅ 平时用 CDN 干什么？

> **缓存静态，过滤攻击，减轻源站压力，给全世界加速**

---

---

## 九、如果你想更偏实战

我可以带你继续往下打到**工程级细节**：

### 可深入方向任选：

#### A. CDN + WAF：完整安全防护设计实战

#### B. 真实缓存策略设计（API / HTML 全覆盖）

#### C. Cloudflare / 阿里云 CDN 实际配置案例

#### D. 大促流量 CDN 扛流实战架构

---

你可以直接说你想深入哪块，我可以按**真实生产经验**给你展开，不写教材套话。
