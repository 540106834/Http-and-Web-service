è®©æˆ‘ä»¬æŠŠé‚£ä»½è„šæœ¬æ‹†å¼€åƒâ€œåˆ†è§£ä¸€å°åˆšä¸Šå²¸çš„æµ·é£æœºå™¨â€ï¼Œæ¯å—é½¿è½®éƒ½äº®æ™¶æ™¶åœ°è®²æ¸…æ¥šã€‚
æˆ‘ç”¨ç®€ç»ƒè¯´æ˜é…ä¸€ç‚¹ç‚¹ç”»é¢æ„Ÿï¼Œä½ å¯ä»¥è¿…é€ŸæŒæ¡æ¯ä¸€æ­¥çš„ç›®çš„ä¸ä½œç”¨ã€‚

---

# 1. å…¨å±€ç»“æ„ï¼šç›®å½•å‡†å¤‡

```bash
BASE_DIR=certs
CA_DIR=$BASE_DIR/ca
SERVER_DIR=$BASE_DIR/server

mkdir -p $CA_DIR $SERVER_DIR
```

è„šæœ¬é¦–å…ˆæ­å»ºä¸€ä¸ªå°å‹ PKI å·¥åŠï¼š

```
certs/
 â”œâ”€â”€ ca/        è´Ÿè´£åˆ¶é€ å’Œä¿ç®¡â€œæ ¹è¯ä¹¦â€
 â””â”€â”€ server/    è´Ÿè´£ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
```

è¿™æ˜¯ä¸ºäº†é¿å…æ–‡ä»¶å †åœ¨ä¸€èµ·ï¼Œåç»­æŸ¥æ‰¾å’Œéƒ¨ç½²éƒ½æ›´æ¸…é†’ã€‚

---

# 2. ç”Ÿæˆ CA ç§é’¥

```bash
openssl genrsa -out $CA_DIR/ca.key 4096
```

è¿™æ˜¯æ•´ä¸ªâ€œè¯ä¹¦ç‹å›½â€çš„å›½ç‹ç§é’¥ï¼Œæ‰€æœ‰ç­¾å‘éƒ½é å®ƒï¼Œå› æ­¤è¦ç”¨ 4096 bit ç¨æ˜¾éš†é‡ã€‚
æ–‡ä»¶ï¼š`ca.key`
ç”¨é€”ï¼šç­¾å‘æ‰€æœ‰ä¸‹çº§è¯ä¹¦ï¼ŒåŒ…æ‹¬ server.crtã€‚

---

# 3. ç”Ÿæˆ CA æ ¹è¯ä¹¦ï¼ˆè‡ªç­¾åï¼‰

```bash
openssl req -x509 -new -nodes \
  -key $CA_DIR/ca.key \
  -sha256 \
  -days 3650 \
  -subj "/C=CN/.../CN=My-Root-CA" \
  -out $CA_DIR/ca.crt
```

è¿™æ˜¯â€œå›½ç‹â€ç»™è‡ªå·±æˆ´çš‡å† ã€‚

ç‰¹ç‚¹ï¼š

* `-x509` è¡¨ç¤ºè‡ªç­¾å
* `ca.key` æ˜¯å®ƒè‡ªå·±çš„ç§é’¥
* æœ‰æ•ˆæœŸ 10 å¹´
* è¾“å‡ºï¼š`ca.crt`

æµè§ˆå™¨/ç³»ç»Ÿä¿¡ä»»æ­¤ CA æ‰èƒ½ä¿¡ä»»å®ƒç­¾å‘çš„æ‰€æœ‰æœåŠ¡å™¨è¯ä¹¦ã€‚

---

# 4. ç”ŸæˆæœåŠ¡å™¨ç§é’¥

```bash
openssl genrsa -out $SERVER_DIR/server.key 2048
```

è¿™æ˜¯â€œæœåŠ¡å™¨çš„ç§äººé’¥åŒ™â€ï¼Œç¨çŸ­ä¸€äº›ä¹Ÿè¶³å¤Ÿå®‰å…¨ã€‚

åç»­ Nginx ä½¿ç”¨å®ƒè¿›è¡Œè§£å¯†ã€æ¡æ‰‹ã€‚

---

# 5. ç”ŸæˆæœåŠ¡å™¨ CSRï¼ˆè¯ä¹¦ç­¾å‘è¯·æ±‚ï¼‰

```bash
openssl req -new \
  -key $SERVER_DIR/server.key \
  -subj "/C=CN/.../CN=localhost" \
  -out $SERVER_DIR/server.csr
```

CSR å°±åƒâ€œå‘ CA é€’äº¤ç”³è¯·è¡¨â€ï¼š

* åŒ…å«æœåŠ¡å™¨å…¬é’¥
* åŒ…å«ä¸»ä½“ä¿¡æ¯ï¼ˆCN=localhostï¼‰
* ç”¨ server.key ç­¾åï¼Œè¯æ˜æ‰€æœ‰æƒ

CA ä¼šæ ¹æ® CSR å†³å®šå¦‚ä½•ç­¾å‘ server.crtã€‚

---

# 6. å†™ä¸€ä¸ª ext é…ç½®æ–‡ä»¶ï¼ˆæ·»åŠ  SANï¼‰

```bash
cat > $SERVER_DIR/server.ext <<EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = 127.0.0.1
IP.1 = 127.0.0.1
EOF
```

æµè§ˆå™¨å¼ºåˆ¶è¦æ±‚è¯ä¹¦å¿…é¡»åŒ…å« **SAN (Subject Alternative Name)**ï¼Œä¸ç„¶ä¼šæŠ¥ï¼š

```
NET::ERR_CERT_COMMON_NAME_INVALID
```

æ‰€ä»¥è¿™é‡Œé€šè¿‡ ext æ–‡ä»¶å£°æ˜è¯ä¹¦ç”¨é€”ã€çº¦æŸå’Œå¯ç”¨åŸŸåã€‚

---

# 7. CA ä¸ºæœåŠ¡å™¨ç­¾å‘è¯ä¹¦

```bash
openssl x509 -req \
  -in $SERVER_DIR/server.csr \
  -CA $CA_DIR/ca.crt \
  -CAkey $CA_DIR/ca.key \
  -CAcreateserial \
  -out $SERVER_DIR/server.crt \
  -days 825 \
  -sha256 \
  -extfile $SERVER_DIR/server.ext
```

åƒ CA æ‹¿ç€ CSRï¼ŒæŸ¥çœ‹ ext æ–‡ä»¶å†…å®¹ï¼Œç„¶åç›–ä¸Šé‡‘è‰²å°ç« ï¼š

* `CA=ca.crt+ca.key` ä»£è¡¨ç”±è‡ªå»º CA ç­¾å‘
* `CAcreateserial` åˆ›å»ºåºåˆ—å·æ–‡ä»¶ `ca.srl`
* æœ‰æ•ˆæœŸ 825 å¤©ï¼ˆä¸šç•Œé€šç”¨ä¸Šé™ï¼‰
* æ·»åŠ  SAN æ‰©å±•

æœ€ç»ˆè¾“å‡ºï¼š`server.crt`

---

# 8. æ‹¼æ¥ fullchainï¼ˆæœåŠ¡ç«¯è¯ä¹¦ + CAï¼‰

```bash
cat $SERVER_DIR/server.crt $CA_DIR/ca.crt > $SERVER_DIR/server.fullchain.crt
```

Nginx æˆ–æŸäº›å®¢æˆ·ç«¯éœ€è¦å®Œæ•´é“¾ï¼Œå¦åˆ™ä¼šå¼¹ï¼š

```
chain incomplete
unable to get local issuer certificate
```

æ”¾ä¸€èµ·åï¼š

```
leaf server cert
+
CA root cert
```

Nginx ä¸€æ¬¡æ€§é€ç»™æµè§ˆå™¨ã€‚

---

# 9. æ–‡ä»¶ç»“æ„å±•ç¤º

```bash
tree $BASE_DIR
```

çº¯ç²¹å°±æ˜¯ä¸ºäº†è®©ä½ è§†è§‰ä¸Šç¡®è®¤æ‰€æœ‰æ–‡ä»¶éƒ½é½Šåœ¨ã€‚

---

# 10. è¾“å‡º Nginx å‚è€ƒé…ç½®

```bash
ssl_certificate      /etc/nginx/certs/server.fullchain.crt
ssl_certificate_key  /etc/nginx/certs/server.key
```

è¿™æ˜¯æœ€å¸¸ç”¨çš„å¯ç›´æ¥å¤åˆ¶ã€‚

---

# æ€»ç»“æˆä¸€æ¡â€œè¯ä¹¦æµæ°´çº¿â€

```
CA key  â†’ CA cert â†’ server key â†’ server CSR â†’ ext â†’ server cert â†’ fullchain
```

æ¯ä¸€æ­¥éƒ½é¡ºæ»‘è¡”æ¥ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜èƒ½ç»§ç»­å¸®ä½ ï¼š

ğŸŸ© åŠ ä¸­çº§ CAï¼Œè®©ä½ çš„ PKI æ›´çœŸå®
ğŸŸ¦ ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”¨äºåŒå‘ TLS
ğŸŸ§ è‡ªåŠ¨ç»­æœŸè„šæœ¬
ğŸŸª ç”¨ Docker ä¸€é”®è¿è¡Œæ•´ä¸ª HTTPS + Nginx ç¯å¢ƒ

ä½ æƒ³æ‰©å±•å“ªä¸€å—ï¼Ÿ
